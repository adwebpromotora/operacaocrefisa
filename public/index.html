<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Leads Crefisa</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f7fa; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); text-align: center; transition: transform 0.2s; }
        .card:hover { transform: translateY(-5px); }
        .card h3 { margin: 0 0 10px; color: #333; }
        .card p { font-size: 1.2em; color: #007bff; }
        .search { margin-bottom: 30px; }
        #searchInput { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 1em; }
        .form { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); margin-bottom: 30px; }
        .form input, .form select, .form textarea { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .form button { padding: 12px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%; }
        .form button:hover { background: #0056b3; }
        .leads-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .lead-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s; }
        .lead-card:hover { transform: translateY(-5px); }
        .lead-card h4 { margin: 0 0 10px; color: #333; }
        .lead-card p { margin: 5px 0; color: #666; }
        .modal { display: none; position: fixed; z-index: 1; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 90%; max-width: 600px; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: #000; }
        .history { margin-top: 20px; }
        .comment { border-top: 1px solid #eee; padding-top: 10px; margin-top: 10px; color: #666; }
        #addCommentBtn { margin-top: 10px; width: 100%; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sistema de Gestão de Leads Crefisa</h1>
        
        <!-- Cards com Indicadores -->
        <div class="cards" id="indicators"></div>
        
        <!-- Busca Inteligente -->
        <div class="search">
            <input type="text" id="searchInput" placeholder="Busque por nome, CPF, telefone, WhatsApp, email ou anotações...">
        </div>
        
        <!-- Formulário de Adição de Lead -->
        <div class="form">
            <h2>Adicionar Novo Lead</h2>
            <input type="text" id="nome" placeholder="Nome Completo" required>
            <input type="text" id="cpf" placeholder="CPF" required>
            <input type="text" id="telefone" placeholder="Telefone">
            <input type="text" id="whatsapp" placeholder="WhatsApp">
            <input type="email" id="email" placeholder="Email">
            <input type="number" id="valorLiberado" placeholder="Valor Liberado" step="0.01" required>
            <textarea id="anotacao" placeholder="Anotação"></textarea>
            <select id="status" required>
                <option value="">Selecione Status</option>
                <option value="fazer contato">Fazer Contato</option>
                <option value="erro">Erro</option>
                <option value="simulado">Simulado</option>
                <option value="sem interesse">Sem Interesse</option>
                <option value="em negociação">Em Negociação</option>
                <option value="vendido">Vendido</option>
            </select>
            <button onclick="addLead()">Adicionar Lead</button>
        </div>
        
        <!-- Grid de Leads -->
        <div id="leadsGrid" class="leads-grid"></div>
    </div>
    
    <!-- Modal de Detalhes do Lead -->
    <div id="leadModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Detalhes do Lead</h2>
            <form id="editForm">
                <input type="hidden" id="editId">
                <input type="text" id="editNome" placeholder="Nome Completo" required>
                <input type="text" id="editCpf" placeholder="CPF" required>
                <input type="text" id="editTelefone" placeholder="Telefone">
                <input type="text" id="editWhatsapp" placeholder="WhatsApp">
                <input type="email" id="editEmail" placeholder="Email">
                <input type="number" id="editValorLiberado" placeholder="Valor Liberado" step="0.01" required>
                <textarea id="editAnotacao" placeholder="Anotação"></textarea>
                <select id="editStatus" required>
                    <option value="fazer contato">Fazer Contato</option>
                    <option value="erro">Erro</option>
                    <option value="simulado">Simulado</option>
                    <option value="sem interesse">Sem Interesse</option>
                    <option value="em negociação">Em Negociação</option>
                    <option value="vendido">Vendido</option>
                </select>
                <button type="button" onclick="saveEdit()">Salvar Alterações</button>
            </form>
            <div class="history">
                <h3>Histórico de Comentários</h3>
                <div id="commentsList"></div>
                <textarea id="newComment" placeholder="Adicionar novo comentário"></textarea>
                <button id="addCommentBtn" onclick="addComment()">Adicionar Comentário</button>
            </div>
        </div>
    </div>

    <script>
        let currentLeadId = null;

        function formatCurrency(value) {
            return `R$ ${parseFloat(value).toFixed(2).replace('.', ',').replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.')}`;
        }

        function checkAuth() {
            fetch('api/auth-check.php')
                .then(res => res.json())
                .then(data => {
                    if (!data.loggedIn) {
                        window.location.href = '/login.html';
                    }
                })
                .catch(() => {
                    window.location.href = '/login.html';
                });
        }

        function updateIndicators() {
            fetch('api/api.php?action=indicators')
                .then(res => {
                    if (res.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    return res.json();
                })
                .then(data => {
                    if (data) {
                        const indicatorsDiv = document.getElementById('indicators');
                        indicatorsDiv.innerHTML = '';
                        const totalCard = createCard('Leads Cadastrados', data.totalLeads);
                        indicatorsDiv.appendChild(totalCard);

                        const statuses = ['fazer contato', 'erro', 'simulado', 'sem interesse', 'em negociação', 'vendido'];
                        statuses.forEach(status => {
                            const title = `Valor Total - ${status.charAt(0).toUpperCase() + status.slice(1)}`;
                            const card = createCard(title, formatCurrency(data[status]));
                            indicatorsDiv.appendChild(card);
                        });
                    }
                });
        }

        function createCard(title, value) {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<h3>${title}</h3><p>${value}</p>`;
            return card;
        }

        function renderLeads(searchTerm = '') {
            fetch(`api/api.php?search=${encodeURIComponent(searchTerm)}`)
                .then(res => {
                    if (res.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    return res.json();
                })
                .then(leads => {
                    if (leads) {
                        const grid = document.getElementById('leadsGrid');
                        grid.innerHTML = '';
                        leads.forEach(lead => {
                            const card = document.createElement('div');
                            card.className = 'lead-card';
                            card.innerHTML = `
                                <h4>${lead.nome}</h4>
                                <p>CPF: ${lead.cpf}</p>
                                <p>Status: ${lead.status}</p>
                                <p>Valor: ${formatCurrency(lead.valor_liberado)}</p>
                            `;
                            card.onclick = () => openModal(lead.id);
                            grid.appendChild(card);
                        });
                    }
                });
        }

        function addLead() {
            const newLead = {
                nome: document.getElementById('nome').value,
                cpf: document.getElementById('cpf').value,
                telefone: document.getElementById('telefone').value,
                whatsapp: document.getElementById('whatsapp').value,
                email: document.getElementById('email').value,
                valorLiberado: document.getElementById('valorLiberado').value,
                anotacao: document.getElementById('anotacao').value,
                status: document.getElementById('status').value
            };
            fetch('api/api.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(newLead)
            }).then(res => {
                if (res.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                return res.json();
            }).then(() => {
                clearAddForm();
                renderLeads();
                updateIndicators();
            });
        }

        function clearAddForm() {
            document.getElementById('nome').value = '';
            document.getElementById('cpf').value = '';
            document.getElementById('telefone').value = '';
            document.getElementById('whatsapp').value = '';
            document.getElementById('email').value = '';
            document.getElementById('valorLiberado').value = '';
            document.getElementById('anotacao').value = '';
            document.getElementById('status').value = '';
        }

        function openModal(id) {
            currentLeadId = id;
            fetch(`api/api.php?id=${id}`)
                .then(res => {
                    if (res.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    return res.json();
                })
                .then(lead => {
                    if (lead) {
                        document.getElementById('editId').value = lead.id;
                        document.getElementById('editNome').value = lead.nome;
                        document.getElementById('editCpf').value = lead.cpf;
                        document.getElementById('editTelefone').value = lead.telefone;
                        document.getElementById('editWhatsapp').value = lead.whatsapp;
                        document.getElementById('editEmail').value = lead.email;
                        document.getElementById('editValorLiberado').value = lead.valor_liberado;
                        document.getElementById('editAnotacao').value = lead.anotacao;
                        document.getElementById('editStatus').value = lead.status;
                        fetchComments(id);
                        document.getElementById('leadModal').style.display = 'flex';
                    }
                });
        }

        function closeModal() {
            document.getElementById('leadModal').style.display = 'none';
            currentLeadId = null;
        }

        function saveEdit() {
            const editedLead = {
                id: document.getElementById('editId').value,
                nome: document.getElementById('editNome').value,
                cpf: document.getElementById('editCpf').value,
                telefone: document.getElementById('editTelefone').value,
                whatsapp: document.getElementById('editWhatsapp').value,
                email: document.getElementById('editEmail').value,
                valorLiberado: document.getElementById('editValorLiberado').value,
                anotacao: document.getElementById('editAnotacao').value,
                status: document.getElementById('editStatus').value
            };
            fetch('api/api.php', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(editedLead)
            }).then(res => {
                if (res.status === 401) {
                    window.location.href = '/login.html';
                    return;
                }
                return res.json();
            }).then(() => {
                closeModal();
                renderLeads(document.getElementById('searchInput').value);
                updateIndicators();
            });
        }

        function addComment() {
            const comment = document.getElementById('newComment').value;
            if (comment) {
                fetch(`api/api.php?action=comments&lead_id=${currentLeadId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ comment })
                }).then(res => {
                    if (res.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    return res.json();
                }).then(() => {
                    fetchComments(currentLeadId);
                    document.getElementById('newComment').value = '';
                });
            }
        }

        function fetchComments(leadId) {
            fetch(`api/api.php?action=comments&lead_id=${leadId}`)
                .then(res => {
                    if (res.status === 401) {
                        window.location.href = '/login.html';
                        return;
                    }
                    return res.json();
                })
                .then(comments => {
                    if (comments) {
                        const list = document.getElementById('commentsList');
                        list.innerHTML = '';
                        comments.forEach(comment => {
                            const div = document.createElement('div');
                            div.className = 'comment';
                            div.textContent = `${new Date(comment.comment_date).toLocaleString('pt-BR')}: ${comment.comment}`;
                            list.appendChild(div);
                        });
                    }
                });
        }

        // Eventos
        document.getElementById('searchInput').addEventListener('input', (e) => renderLeads(e.target.value));

        // Inicialização
        checkAuth();
        renderLeads();
        updateIndicators();

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            const modal = document.getElementById('leadModal');
            if (event.target === modal) closeModal();
        }
    </script>
</body>
</html>
